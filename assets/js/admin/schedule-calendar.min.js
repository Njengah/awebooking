!function(){"use strict";function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var r,o,d,i,s,e;r=jQuery,window.flatpickr,o=window.moment,d=60,i="YYYY-MM-DD",s=Backbone.Model.extend({defaults:{endDate:null,startDate:null,calendar:null},clear:function(){this.clearSelectedDate(null)},isValid:function(){return!(!this.has("calendar")||this.get("calendar")<1)&&0<=this.getNights()},clearSelectedDate:function(e){this.set({startDate:null,endDate:null}),this.set("calendar",e),this.trigger("clear_dates")},getNights:function(){return this.has("endDate")&&this.has("startDate")?this.get("endDate").diff(this.get("startDate"),"days"):-1}}),e=Backbone.View.extend({options:{debug:!1,marker:".scheduler__marker",popper:".scheduler__popper > .scheduler__actions",granularity:"nightly"},events:{"click      .scheduler__body .scheduler__date":"setSelectionDate","mouseenter .scheduler__body .scheduler__date":"drawMarkerOnHover"},initialize:function(e){this.options=_.defaults(e||{},this.options),this.model=new s;var t=this.$el.find(".scheduler__column").first().outerWidth();d<t&&(d=t),this.$el.find(".scheduler__actions [data-schedule-action]").on("click",this.handleClickAction.bind(this)),this.$marker=this.$el.find(this.options.marker),this.$marker.hide(),this.setupPopper(),this.popper=this.$marker[0]._tippy,window.Waypoint&&this.setupLabelAnimate(),r(document).on("keyup",this.onKeyup.bind(this)),this.listenTo(this.model,"change:startDate change:endDate",this.setMarkerPosition),this.listenTo(this.model,"clear_dates",this.onClearSelectedDates),this.options.debug&&this.listenTo(this.model,"change",this.debug),this.$el.data("scheduler",this)},debug:function(){this.model.has("startDate")&&this.model.has("endDate")?console.log(this.model.get("calendar"),this.model.get("startDate").format(i)+" - "+this.model.get("endDate").format(i)):this.model.has("startDate")?console.log(this.model.get("calendar"),this.model.get("startDate").format(i)+" - null"):this.model.has("endDate")?console.log(this.model.get("calendar"),"null - "+this.model.get("endDate").format(i)):console.log("null - null")},onKeyup:function(e){27==e.keyCode&&this.model.clearSelectedDate()},handleClickAction:function(e){e.preventDefault();var t=r(e.currentTarget);return!!this.model.isValid()&&(!!t.data("scheduleAction")&&void this.trigger("action:"+t.data("scheduleAction"),e,this.model))},onClearSelectedDates:function(){this.popper.hide(),this.$marker.find("span").text(0),this.trigger("clear")},setSelectionDate:function(e){var t=r(e.currentTarget),a=this.getUnitByElement(t),i=o(t.data("date"));if(this.model.has("startDate")&&this.model.has("endDate"))this.model.clearSelectedDate(a);else{if((this.model.has("calendar")&&a!==this.model.get("calendar")||this.model.has("startDate")&&i.isBefore(this.model.get("startDate"),"day"))&&this.model.clearSelectedDate(a),!this.model.has("startDate")&&!this.model.has("endDate"))return this.model.set("calendar",a),this.model.set("startDate",i.clone()),void this.drawMarkerOnHover(e);"nightly"==this.options.granularity&&i.diff(this.model.get("startDate"),"days")<1||(this.popper.show(),this.model.set("endDate",i.clone()),this.trigger("apply",this.model,this))}},setMarkerPosition:function(){var e=this.model.get("endDate"),t=this.model.get("startDate");if(_.isNull(t)&&_.isNull(e))this.$marker.css("width",d).hide();else{var a=this.getElementByDate(this.model.get("calendar"),t);if(_.isNull(e)){var i=this.getCellPossiton(a);this.$marker.show().css({top:i.top,left:i.left})}else{var s=this.getElementByDate(this.model.get("calendar"),e);this.$marker.css("width",(s.index()-a.index()+1)*d)}}},drawMarkerOnHover:function(e){var t=r(e.currentTarget),a=this.getUnitByElement(t);if(this.model.has("calendar")&&this.model.get("calendar")===a&&this.model.has("startDate")&&(!this.model.has("startDate")||!this.model.has("endDate"))){var i=o(t.data("date")),s=this.model.get("startDate");if(s.isSameOrBefore(i,"day")){var n=this.getElementByDate(a,s),l=t.index()-n.index()+1;this.$marker.css("width",l*d),this.$marker.find("span").text("daily"==this.options.granularity?l:l-1)}}},getElementByDate:function(e,t){return"object"===a(t)&&(t=t.format(i)),this.$el.find('[data-calendar="'+e+'"]').find('.scheduler__date[data-date="'+t+'"]')},getUnitByElement:function(e){var t=r(e).data("calendar");return void 0===t&&(t=r(e).closest("[data-calendar]").data("calendar")),t=parseInt(t,10),isNaN(t)?0:t},getCellPossiton:function(e){var t=e.offset(),a=this.$el.find(".scheduler__body").offset();return{top:t.top-a.top,left:t.left-a.left}},setupPopper:function(){tippy(this.$marker[0],{html:this.$el.find(this.options.popper)[0],theme:"abrs-tippy",arrow:!0,distance:0,trigger:"manual",placement:"bottom",hideOnClick:"persistent",interactive:!0,performance:!0,animation:"shift-away",duration:[150,150],popperOptions:{modifiers:{hide:{enabled:!1},preventOverflow:{enabled:!1}}}})},setupLabelAnimate:function(){var i=this,e=i.$el.find(".scheduler__main")[0],t=function(e){var t=i.$el.find(".scheduler__aside .scheduler__month-label"),a=r(this.element);"right"===e?(a.attr("data-prev-text",t.text()),t.text(a.text())):(t.text(a.data("prevText")),a.attr("data-prev-text",""))};i.$el.find(".scheduler__month-label").each(function(){new Waypoint({element:this,context:e,offset:-50,horizontal:!0,handler:t})})}}),window.ScheduleCalendar=e}();